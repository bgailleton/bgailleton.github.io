{{ $dem := resources.Get "images/hydrodynamics-dem.tif" }}
{{ $count := add 1 (default 0 (.Page.Scratch.Get "hydro-count")) }}
{{ .Page.Scratch.Set "hydro-count" $count }}
{{ $inputID := printf "hydro-qx-%d" $count }}
{{ $modeGroup := printf "hydro-mode-%d" $count }}

<div class="hydro-panel"
     data-hydro-demo
     data-dem="{{ $dem.RelPermalink }}">
  <div class="hydro-controls">
    <div class="hydro-control-group hydro-control-group--mode">
      <div class="hydro-mode-header">
        <span>Solver mode</span>
        <small>Switching modes resets the computation.</small>
      </div>
      <div class="hydro-mode-options" role="radiogroup" aria-label="Solver mode selector">
        <label>
          <input
            type="radio"
            name="{{ $modeGroup }}"
            value="transient"
            data-role="mode-input"
            checked>
          Transient (LisFlood)
        </label>
        <label>
          <input
            type="radio"
            name="{{ $modeGroup }}"
            value="stationary"
            data-role="mode-input">
          Stationary (GraphFlood)
        </label>
      </div>
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-precip">
        <span>Precipitation (mm/hr)</span>
        <output data-role="precip-output">--</output>
      </label>
      <input
        id="{{ $inputID }}-precip"
        data-role="precip-slider"
        type="range"
        min="0"
        max="100"
        step="0.5"
        value="5">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-discharge">
        <span>Point discharge (m^3/s)</span>
        <output data-role="discharge-output">--</output>
      </label>
      <input
        id="{{ $inputID }}-discharge"
        data-role="discharge-slider"
        type="range"
        min="1"
        max="500"
        step="1"
        value="100">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-manning">
        <span>Surface roughness (Manning n)</span>
        <output data-role="manning-output">--</output>
      </label>
      <input
        id="{{ $inputID }}-manning"
        data-role="manning-slider"
        type="range"
        min="0.001"
        max="0.1"
        step="0.001"
        value="0.033">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-depth">
        <span data-role="metric-label">Depth scale for blue (m)</span>
        <output data-role="depth-output">--</output>
      </label>
      <input
        id="{{ $inputID }}-depth"
        data-role="depth-slider"
        type="range"
        min="0.5"
        max="3"
        step="0.1"
        value="2.5">
    </div>
    <div class="hydro-control-group" data-role="qw-opacity-group" hidden>
      <label for="{{ $inputID }}-qw-opacity">
        <span>Discharge overlay opacity</span>
        <output data-role="qw-opacity-output">--</output>
      </label>
      <input
        id="{{ $inputID }}-qw-opacity"
        data-role="qw-opacity-slider"
        type="range"
        min="0"
        max="1"
        step="0.05"
        value="0.65">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-direction">
        <span>Sun direction (deg)</span>
      </label>
      <input
        id="{{ $inputID }}-direction"
        data-role="sun-dir-slider"
        type="range"
        min="0"
        max="359"
        step="1"
        value="90">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-zenith">
        <span>Sun zenith (deg)</span>
      </label>
      <input
        id="{{ $inputID }}-zenith"
        data-role="sun-zenith-slider"
        type="range"
        min="10"
        max="80"
        step="1"
        value="34">
    </div>
    <div class="hydro-control-group">
      <label for="{{ $inputID }}-contrast">
        <span>Hillshade contrast</span>
      </label>
      <input
        id="{{ $inputID }}-contrast"
        data-role="hill-contrast-slider"
        type="range"
        min="0.1"
        max="5"
        step="0.1"
        value="1.5">
    </div>
    <p>Inject a single-pixel pulse in the basin center, then adjust the color scale to inspect thin overland flow versus deep pooling.</p>
  </div>
  <div class="hydro-canvas">
    <canvas aria-label="Hydrodynamics shallow-water simulation"></canvas>
    <div class="hydro-overlay hydro-overlay--status" aria-live="polite">
      <span>Sim time</span>
      <strong data-role="hydro-time">0.0 s</strong>
    </div>
    <div class="hydro-overlay hydro-overlay--controls" aria-label="Visualization options">
      <div class="hydro-overlay-block">
        <span>Display</span>
        <div class="hydro-toggle-group" role="group" aria-label="Display mode">
          <button type="button" class="hydro-toggle is-active" data-role="display-mode-button" data-mode="depth">
            Depth
          </button>
          <button type="button" class="hydro-toggle" data-role="display-mode-button" data-mode="discharge">
            Qw
          </button>
        </div>
      </div>
      <div class="hydro-overlay-block">
        <span>View</span>
        <div class="hydro-toggle-group" role="group" aria-label="View mode">
          <button type="button" class="hydro-toggle is-active" data-role="view-toggle-button" data-view="2d">
            2D
          </button>
          <button type="button" class="hydro-toggle" data-role="view-toggle-button" data-view="3d">
            3D
          </button>
        </div>
      </div>
    </div>
    <div class="hydro-scale" aria-hidden="true">
      <div class="hydro-scale-bar" data-role="hydro-scale-bar"></div>
      <span>100&nbsp;m</span>
    </div>
  </div>
</div>

{{ if not (.Page.Scratch.Get "hydro-geotiff") }}
  {{ $geotiff := resources.Get "js/vendor/geotiff.min.js" | resources.Fingerprint }}
  {{ .Page.Scratch.Set "hydro-geotiff" $geotiff }}
{{ end }}
{{ if not (.Page.Scratch.Get "hydro-script") }}
  {{ $script := resources.Get "js/hydrodynamics.js" | resources.Minify | resources.Fingerprint }}
  {{ .Page.Scratch.Set "hydro-script" $script }}
{{ end }}
